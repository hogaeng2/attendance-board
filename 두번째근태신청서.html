<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최종 통합 코드</title>
    <style>
        /* 기존 스타일 */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #2c2c2c;
            color: #e0e0e0;
        }
        textarea {
            resize: none;
            height: 100px;
        }
        button {
            background-color: #007bff;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }
        .approval-section {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #444;
        }
        th {
            background-color: #333;
        }
        .alert-log {
            margin-top: 20px;
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>최종 통합 코드</h1>
        <form id="attendanceForm">
            <div class="form-group">
                <label for="name">성명</label>
                <input type="text" id="name" placeholder="이름을 입력하세요">
            </div>
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" placeholder="비밀번호를 입력하세요">
            </div>
            <div class="form-group">
                <label for="department">소속</label>
                <select id="department">
                    <option value="">선택</option>
                    <option value="도매1팀">도매1팀</option>
                    <option value="전략팀">전략팀</option>
                    <option value="고객마케팅팀">고객마케팅팀</option>
                    <option value="고객관리팀">고객관리팀</option>
                    <option value="정책팀">정책팀</option>
                    <option value="혁신팀">혁신팀</option>
                    <option value="컴플라이언스">컴플라이언스</option>
                    <option value="정산팀">정산팀</option>
                    <option value="재무회계팀">재무회계팀</option>
                    <option value="유선지원팀">유선지원팀</option>
                    <option value="유선영업팀">유선영업팀</option>
                </select>
            </div>
            <div class="form-group">
                <label for="position">직위</label>
                <select id="position">
                    <option value="">선택</option>
                    <option value="사원">사원</option>
                    <option value="대리">대리</option>
                    <option value="과장">과장</option>
                    <option value="차장">차장</option>
                    <option value="팀장">팀장</option>
                    <option value="부서장">부서장</option>
                    <option value="이사">이사</option>
                    <option value="본부장">본부장</option>
                </select>
            </div>
            <div class="form-group">
                <label for="phone">전화번호</label>
                <input type="tel" id="phone" placeholder="전화번호를 입력하세요">
            </div>
            <div class="form-group">
                <label for="leaveType">근태 유형</label>
                <select id="leaveType">
                    <option value="">선택</option>
                    <option value="연차휴가">연차휴가</option>
                    <option value="조퇴">조퇴</option>
                    <option value="외출">외출</option>
                </select>
            </div>
            <div class="form-group">
                <label for="startDate">신청 시작 일자</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label for="endDate">신청 종료 일자</label>
                <input type="date" id="endDate">
            </div>
            <div class="form-group">
                <label for="reason">신청 이유</label>
                <textarea id="reason" placeholder="신청 이유를 입력하세요"></textarea>
            </div>
            <button type="button" onclick="submitForm()">신청서 제출</button>
            <button type="button" id="editButton" class="hidden" onclick="editForm()">수정</button>
        </form>

        <div class="approval-section hidden" id="approvalSection">
            <h2>결재 상태</h2>
            <table>
                <thead>
                    <tr>
                        <th>결재자</th>
                        <th>결재 상태</th>
                        <th>결재 옵션</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="teamLeaderRow" class="hidden">
                        <td>팀장</td>
                        <td id="teamLeaderStatus">대기 중</td>
                        <td>
                            <select id="teamLeaderOption" onchange="handleApproval('팀장')">
                                <option value="">선택</option>
                                <option value="승인">승인</option>
                                <option value="반려">반려</option>
                            </select>
                            <textarea id="teamLeaderReason" class="hidden" placeholder="반려 사유"></textarea>
                        </td>
                    </tr>
                    <tr id="departmentHeadRow" class="hidden">
                        <td>부서장</td>
                        <td id="departmentHeadStatus">대기 중</td>
                        <td>
                            <select id="departmentHeadOption" onchange="handleApproval('부서장')">
                                <option value="">선택</option>
                                <option value="승인">승인</option>
                                <option value="반려">반려</option>
                            </select>
                            <textarea id="departmentHeadReason" class="hidden" placeholder="반려 사유"></textarea>
                        </td>
                    </tr>
                    <tr id="directorRow" class="hidden">
                        <td>이사</td>
                        <td id="directorStatus">대기 중</td>
                        <td>
                            <select id="directorOption" onchange="handleApproval('이사')">
                                <option value="">선택</option>
                                <option value="승인">승인</option>
                                <option value="반려">반려</option>
                            </select>
                            <textarea id="directorReason" class="hidden" placeholder="반려 사유"></textarea>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="alert-log" id="alertLog">
            <h3>알림 로그</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // 실제 사용자 정보
        const allowedUsers = {
            teamLeader: "박진영",  // 팀장
            departmentHead: "박준형",  // 부서장
            director: "박효신"  // 이사
        };

        let currentUser = null;

// 직위별 사원 목록과 고유 ID 관리
const userRoles = {
    "사원": {
        "홍길동": "userId_홍길동",
        "김길동": "userId_김길동",
        "박동수": "userId_박동수"
    },
    "대리": {
        "이철수": "userId_이철수",
        "김영희": "userId_김영희",
        "정하늘": "userId_정하늘"
    },
    "과장": {
        "윤세미": "userId_윤세미",
        "최강준": "userId_최강준",
        "한예슬": "userId_한예슬"
    },
    "차장": {
        "박진영": "userId_박진영"
    },
    "부서장": {
        "박준형": "userId_박준형"
    },
    "이사": {
        "박효신": "userId_박효신"
    }
};

// 사용자가 직위와 이름을 입력하면 고유 ID를 가져오는 함수
function getUserIdByRole(role, name) {
    if (userRoles[role] && userRoles[role][name]) {
        return userRoles[role][name];  // 직위와 이름을 기반으로 고유 ID 반환
    } else {
        return null;  // 없으면 null 반환
    }
}

// 사용 예시: "사원" 직위에 "홍길동"이라는 이름을 가진 사원의 고유 ID 가져오기
const userId = getUserIdByRole("사원", "홍길동");  // "userId_홍길동"을 반환
if (userId) {
    sendPushNotification(userId, "홍길동님의 신청서가 제출되었습니다.");
} else {
    console.log("해당 사용자 아이디를 찾을 수 없습니다.");
}

// 푸시 알림 전송 함수 (예시)
function sendPushNotification(userId, message) {
    console.log(`푸시 알림을 ${userId}에게 전송: ${message}`);
    // 여기에 실제 푸시 알림 API 호출 로직이 들어갑니다.
}

        // 신청서 제출
        function submitForm() {
            const name = document.getElementById('name').value;
            const position = document.getElementById('position').value;
            if (!name || !position) {
                alert("모든 항목을 입력해주세요.");
                return;
            }

            // 알림 로그
            const alertLog = document.getElementById('logContainer');
            alertLog.innerHTML += `<p>${name}의 신청서가 제출되었습니다. (팀장: ${allowedUsers.teamLeader})</p>`;

            document.getElementById('editButton').classList.remove('hidden');  // 수정 버튼 표시

            // 사원일 때 결재 상태창 아무도 안 보이도록
            if (position === '사원') {
                return;
            }

            // 결재자일 경우에만 결재 상태창 표시
            if (position === '팀장' && allowedUsers.teamLeader === "박진영") {
                document.getElementById('approvalSection').classList.remove('hidden');
                document.getElementById('teamLeaderRow').classList.remove('hidden');
            } else if (position === '부서장' && allowedUsers.departmentHead === "박준형") {
                document.getElementById('approvalSection').classList.remove('hidden');
                document.getElementById('departmentHeadRow').classList.remove('hidden');
            } else if (position === '이사' && allowedUsers.director === "박효신") {
                document.getElementById('approvalSection').classList.remove('hidden');
                document.getElementById('directorRow').classList.remove('hidden');
            }
        }

        // 결재 처리
        function handleApproval(role) {
            const statusElement = document.getElementById(role + 'Status');
            const reasonElement = document.getElementById(role + 'Reason');
            const option = document.getElementById(role + 'Option').value;
            const alertLog = document.getElementById('logContainer');

            if (option === '승인') {
                statusElement.innerHTML = '승인';
                alertLog.innerHTML += `<p>${allowedUsers[role]}가 신청서를 승인했습니다.</p>`;
                showNextRole(role);
                // 승인 알림
                if (role === '팀장') {
                    sendPushNotification("departmentHeadId", "팀장이 신청서를 승인했습니다.");
                } else if (role === '부서장') {
                    sendPushNotification("directorId", "부서장이 신청서를 승인했습니다.");
                } else if (role === '이사') {
                    sendPushNotification("employeeId", "이사가 신청서를 승인했습니다.");
                }
            } else if (option === '반려') {
                statusElement.innerHTML = '반려';
                reasonElement.classList.remove('hidden');
                alertLog.innerHTML += `<p>${allowedUsers[role]}가 신청서를 반려했습니다. 이유: ${reasonElement.value}</p>`;
                // 반려 알림
                if (role === '팀장') {
                    sendPushNotification("employeeId", `팀장이 신청서를 반려했습니다. 사유: ${reasonElement.value}`);
                } else if (role === '부서장') {
                    sendPushNotification("employeeId", `부서장이 신청서를 반려했습니다. 사유: ${reasonElement.value}`);
                } else if (role === '이사') {
                    sendPushNotification("employeeId", `이사가 신청서를 반려했습니다. 사유: ${reasonElement.value}`);
                }
            }

            // 상태 저장
            saveApprovalState();  // 결재 상태를 로컬 스토리지에 저장
        }

        // 푸시 알림 전송 (스윙투앱 API 사용)
        function sendPushNotification(userId, message) {
            const pushApiUrl = "https://api.swingapp.com/push-notifications"; // 스윙투앱 푸시 API URL
            const apiKey = "40253a48-ac21-47fe-92a1-e51c0f885334"; // 스윙투앱에서 발급받은 API 키

            const notificationData = {
                userId: userId, // 푸시 알림을 받을 사용자 ID
                message: message, // 알림 메시지
                title: "결재 상태 업데이트", // 알림 제목
                timestamp: new Date().toISOString() // 타임스탬프 (필요한 경우)
            };

            fetch(pushApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(notificationData)
            })
            .then(response => response.json())
            .then(data => {
                console.log("푸시 알림 전송 성공:", data);
            })
            .catch(error => {
                console.error("푸시 알림 전송 실패:", error);
            });
        }

        // 결재 섹션 표시
        function showNextRole(role) {
            if (role === '팀장') {
                document.getElementById('departmentHeadRow').classList.remove('hidden');  // 부서장에게 결재 요청
            } else if (role === '부서장') {
                document.getElementById('directorRow').classList.remove('hidden');  // 이사에게 결재 요청
            }
        }

        // 상태 저장
        function saveApprovalState() {
            const teamLeaderStatus = document.getElementById('teamLeaderStatus').innerText;
            const departmentHeadStatus = document.getElementById('departmentHeadStatus').innerText;
            const directorStatus = document.getElementById('directorStatus').innerText;
            const teamLeaderOption = document.getElementById('teamLeaderOption').value;
            const departmentHeadOption = document.getElementById('departmentHeadOption').value;
            const directorOption = document.getElementById('directorOption').value;

            // 상태 객체 생성
            const statusObj = {
                teamLeader: teamLeaderStatus,
                departmentHead: departmentHeadStatus,
                director: directorStatus,
                teamLeaderOption: teamLeaderOption,
                departmentHeadOption: departmentHeadOption,
                directorOption: directorOption
            };

            // 로컬 스토리지에 상태 저장
            localStorage.setItem('approvalState', JSON.stringify(statusObj));
        }

        // 페이지 로드 시 결재 상태 복원
        window.onload = function() {
            loadApprovalState();  // 로컬 스토리지에서 결재 상태를 불러오기
        };

        // 결재 상태 복원
        function loadApprovalState() {
            const savedStatus = localStorage.getItem('approvalState');
            if (savedStatus) {
                const statusObj = JSON.parse(savedStatus);
                document.getElementById('teamLeaderStatus').innerText = statusObj.teamLeader || '대기 중';
                document.getElementById('departmentHeadStatus').innerText = statusObj.departmentHead || '대기 중';
                document.getElementById('directorStatus').innerText = statusObj.director || '대기 중';
                // 각 결재자의 상태와 선택을 복원
                document.getElementById('teamLeaderOption').value = statusObj.teamLeaderOption || '';
                document.getElementById('departmentHeadOption').value = statusObj.departmentHeadOption || '';
                document.getElementById('directorOption').value = statusObj.directorOption || '';
            }
        }
    </script>
</body>
</html>
